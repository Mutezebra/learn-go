# Golang 第六轮作业

## 目的

- 掌握微服务架构和Web工作原理
- 掌握HTTP协议和RPC调度方法
- 掌握BASE、CAP理论

## 背景

由于疫情封校了，FanOne和小哥哥们外出Happy的计划泡汤了，只能在宿舍一起网聊。她的小哥哥们提出和她一起在手机上看片，为了让FanOne和她的小哥哥们可以快乐看片，请你写一个基于**微服务架构**的视频网站，让FanOne能够享受封校生活！

## 任务

请遵照以下接口文档完成功能

[https://apifox.com/apidoc/shared-dcb1a5ef-5c75-4a0e-9486-e3bd748379a0](https://apifox.com/apidoc/shared-dcb1a5ef-5c75-4a0e-9486-e3bd748379a0)

本次作业没有新增需求，你的主要任务是将上一轮的作业升级成**微服务架构**

如果你还不了解微服务架构，可以阅读这篇文章[微服务架构 Intro](https://west2-online.feishu.cn/wiki/LfgfwMwZFibcvRkVlR2ctlEenBe?from=from_copylink)

### 架构设计

你需要设计一个合理的微服务架构

- 将项目拆分成小模块，这些模块可以独立的开发、部署和扩展。
- 避免微服务之间直接共享数据，至少不能共享同一张表
- 尽量避免RPC循环调用

### 服务注册与发现

在这一轮中，你需要在你的项目中实现服务注册和发现

服务注册与发现是一种机制，用于管理和维护微服务架构中各个服务的地址和元数据的组件。

通过服务注册与发现，可以**动态地**发现和调用其他微服务，从而简化了系统的管理和维护。

### 性能优化

在上一轮作业中，很多同学尝试很多性能优化的办法，但是有的优化可能不太合理

为了进一步理解性能优化的应用和效果，我们需要你进行一定的测试来显示出性能优化的**效果**(如使用Benchmark测试)，并且在**文档中展示**出你的优化**内容**、优化**效果**以及描述接口逻辑的**流程图**（如有）

我们希望你的文档可以帮我们快速**定位**到项目中的代码位置（添加一些描述，或者给流程图添加一些提示内容）

同时，架构升级之后，也会有一些**新的**可优化的点出现

### 文档优化

在上一轮作业中，大部分人的文档都写的不是很好，我们希望你进一步优化你的文档，**不限制格式**、内容，但需要拥有以下内容

1. （Problem Restatement）问题重述：用**最简短**的话复述你这次需要完成的内容
2. （問題が解決しました）问题解决：使用打勾（复选框）来示意你**全部完成的内容**，对于部分完成的内容，请不要打勾，而是描述你目前已经完成的内容
3. （如有）（Spotlight）项目亮点：这部分不是必须的，如果你认为你的项目**有一些巧思**，请写上
4. （如有）（Advancement）进阶：超出文档需求的完成量，比如实现了部分Bonus 内容，则在这部分描述
5. （如有）（Argument）抱怨：你对这个文档存在的不足的抱怨，请尽量写，**不要害羞**，最好不要写个无

PS：你是否在上一轮中有一些没完成或者遗漏的内容？如果有，请在这一轮完成

我非常建议大家在~~坐牢~~学习新知识的时候在文档里做一些笔记和记录，这有利于量化你的学习内容并且使知识更加系统，我们也可以更加了解你的学习过程~~（学不下去了就在文档里发电）~~

### Bonus

1. 对项目使用链路追踪（例如[Jaeger](https://github.com/jaegertracing/jaeger)）

2. 对项目提供监控特性（例如[Prometheus](https://github.com/prometheus/prometheus) 与  [Skywalking](https://skywalking.apache.org/)）

3. 项目支持负载均衡（Load Balance），实现轮询（Round-Robin）策略即可

4. 项目中集成熔断降级功能，推荐使用框架 [hystrix](github.com/afex/hystrix-go/hystrix)

   1. 尝试使用另一个很热门的rpc框架[Kratos](https://github.com/go-kratos/kratos)，写一份kitex 和 kratos 对比报告（对比往往要写一点Demo），报告内容包括

   - 框架的各种支持与扩展对比
   - 不同并发量下的吞吐率（每秒完成的调用数）和延迟（平均耗时）
   - 别的你的心得体会

5. 添加一个上传视频的接口，具体实现为

   - 使用流式请求分片上传视频

   - 与用户绑定（即对于每个视频，都要求在数据库中设定上传者、上传时间等内容



## 参考

常见的RPC框架

| 公司     | 名称    | 地址                                 |
| -------- | ------- | ------------------------------------ |
| 谷歌     | grpc-go | https://github.com/grpc/grpc-go      |
| 七牛     | go-zero | https://github.com/zeromicro/go-zero |
| Bilibili | Kratos  | https://github.com/go-kratos/kratos  |
| 字节跳动 | Kitex   | https://github.com/cloudwego/kitex   |
| Apache   | Dubbo   | https://github.com/apache/dubbo-go   |
| 腾讯     | Tars    | https://github.com/TarsCloud/TarsGo  |
| 斗鱼     | jupiter | https://github.com/douyu/jupiter     |

建议学习一些资料较为完善的RPC框架，比如grpc-go，这里不推荐go-micro，因为国内用的少且版本比较混乱。

| 标题                                                         | 地址                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| Google API 设计指南                                          | https://cloud.google.com/apis/design                         |
| 如何才能更好的学习MIT 6.824？                                | https://zhuanlan.zhihu.com/p/110168818                       |
| MIT 6.824课程中文学习资料                                    | https://mit-public-courses-cn-translatio.gitbook.io/mit6-824/ |
| Sorosliu1029/6.824                                           | https://github.com/Sorosliu1029/6.824                        |
| 字节跳动自研高性能微服务框架Kitex的演进之旅                  | https://juejin.cn/post/7098631562232594462                   |
| RPC框架Kitex实践入门：性能测试指南                           | https://juejin.cn/post/7033972008257847304                   |
| 高性能RPC框架CloudWeGo-Kitex内外统一的开源实践               | https://juejin.cn/post/7148688078083915807                   |
| [译] Go 语言的整洁架构之道 —— 一个使用 gRPC 的 Go 项目整洁架构例子 | https://juejin.cn/post/6844903687463108616                   |
| 写给go开发者的gRPC教程-protobuf基础                          | https://juejin.cn/post/7191008929986379836                   |
| go基于grpc构建微服务框架-服务注册与发现                      | https://juejin.cn/post/6844903593758162958                   |
| 《gor入门grpc》第一章：什么是gRPC                            | https://segmentfault.com/a/1190000043343832                  |
| Raft算法动画演示                                             | https://github.com/klboke/raft-animation                  |

当然，这里面只列举了一部分内容，微服务的资料网上非常非常的多

## 提示

你可能需要先学习一定的云原生知识（不需要学习太深，我们现在只是做一个toy demo）：[云原生资料库](https://lib.jimmysong.io/)

- 每个厂都会有自己开源的RPC框架，选择哪个RPC框架都无所谓，主要是学习微服务的思想，本质都是一样的
- 不过这些厂开源的RPC框架都非常的完善，以至于实现起来很简单，比如服务注册可以直接调用封装好的功能，虽然提高了开发流程，**但不建议初学者这样使用**，容易成为API工程师。建议使用相对原始一点的rpc框架如grpc-go来自己实现一个服务注册与发现的方法



如果你想深入学习分布式，可以参考下面这些提示，同时尝试**先**完成所有的Bonus

1. 学习MIT-6.824
2. 了解分布式注册中心，如 etcd , zookeeper , euruka 等，并在代码中封装分布式系统中的服务注册、服务发现功能。有兴趣还可以了解一下Raft算法，参考[hashicorp/raft](https://github.com/hashicorp/raft)
3. 可以学习一些分布式存储方面的技术，如MySQL主从复制、读写分离、高可用配置，Redis的分布式锁(Redlock 算法)、主从模式和哨兵模式，ELK日志系统等。
4. 可学习Kubernetes基础，并提前了解云原生方向 https://www.cncf.io/
